# 服务降级

>服务降级:主要是针对非正常情况下的应急服务措施；比如电商平台，在针对618、双11等高峰情形下采用部分服务不出现或者延时出现的情形。


**1、服务降级的特征**

```
原因：整体负荷超出整体负载承受能力。

目的：保证重要或基本服务正常运行，非重要服务延迟使用或暂停使用
```

<br>

**2、降级的方式**

>(1).延迟服务:比如发表了评论，可以在文章中显示正常，但是延迟给用户增加积分，只是放到一个缓存中，等服务平稳之后再执行


>(2).在粒度范围内关闭服务(片段降级或服务功能降级):比如关闭相关文章的推荐，直接关闭推荐区


>(3).写降级:比如秒杀抢购，我们可以只进行Cache的更新，然后异步同步扣减库存到DB，保证最终一致性即可，此时可以将DB降级为Cache


<br>

**3、降级预案**

在进行降级之前要对系统进行梳理，看看系统是不是可以丢卒保帅；从而梳理出哪些必须誓死保护，哪些可降级；比如可以参考日志级别设置预案：

>一般:比如有些服务偶尔因为网络抖动或者服务正在上线而超时，可以自动降级


>警告:有些服务在一段时间内成功率有波动(如在95~100%之间)，可以自动降级或人工降级，并发送告警


>错误:比如可用率低于90%，或者数据库连接池被打爆了，或者访问量突然猛增到系统能承受的最大阀值，此时可以根据情况自动降级或者人工降级


>严重错误:比如因为特殊原因数据错误了，此时需要紧急人工降级

<br>

**4、自动降级分类**

>(1).超时降级:主要配置好超时时间和超时重试次数和机制


>(2).失败次数降级:主要是一些不稳定的api，当失败调用次数达到一定阀值自动降级


>(3).故障降级:比如要调用的远程服务挂掉了(网络故障、DNS故障、http服务返回错误的状态码、rpc服务抛出异常)，则可以直接降级。降级后的处理方案有:默认值(比如库存服务挂了，返回默认现货)、兜底数据(比如广告挂了，返回提前准备好的一些静态页面)、缓存(之前暂存的一些缓存数据)


>(4).限流降级:当我们去秒杀或者抢购一些限购商品时，此时可能会因为访问量太大而导致系统崩溃，此时开发者会使用限流来进行限制访问量，当达到限流阀值，后续请求会被降级；降级后的处理方案可以是:排队页面(将用户导流到排队页面等一会重试)、无货(直接告知用户没货了)、错误页(如活动太火爆了，稍后重试)。
